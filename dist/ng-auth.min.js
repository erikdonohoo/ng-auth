/*! ng-auth 04-05-2015 v1.0.0 */
!function(a,b){"use strict";function c(b,c){var d=Date.now();return b.expires_at=b.expires_at||d+1e3*b.expires_in-k,c.sessionStorage[l+"-"+j.client_id]=a.toJson(b),b}function d(b,c){var d=a.copy(b),e=d.oauth2_url+"?",f=c.url(),g=c.absUrl().split("#")[0].split("?")[0];return e+="client_id="+d.client_id,e=d.scope.length?e+"&scope="+d.scope.join(" ").replace(/\s/g,"%20"):e,e=d.state===!0?e+"&state="+encodeURIComponent(f):a.isString(d.state)?e+"&state="+encodeURIComponent(d.state):e,e+="&response_type=token",e=d.redirect_uri===!0?e+"&redirect_uri="+g:e+"&redirect_uri="+d.redirect_uri,a.forEach(d.options,function(a,b){e+="&"+b+"="+a}),e}function e(a){var c,d={},e="",f=a.split("#");if(f.length>1)for("/"===f[1].charAt(0)&&(f[1]=f[1].substring(1)),e=f[1];c=m.exec(e);)d[decodeURIComponent(c[1])]=decodeURIComponent(c[2]);return d.hash=f[2],d.hash===b&&delete d.hash,d}function f(b,c){var d=!1;return a.forEach(c.content_urls,function(a){0===b.indexOf(a)&&(d=!0)}),d}function g(b){j.state=b.state||j.state,j.redirect_uri=b.redirectUri||j.redirect_uri,a.isArray(b.contentUrls)&&a.forEach(b.contentUrls,function(a){-1===j.content_urls.indexOf(a)&&j.content_urls.push(a)}),j.popup=b.popup||j.popup,a.isArray(b.scope)&&a.forEach(b.scope,function(a){-1===j.scope.indexOf(a)&&j.scope.push(a)}),j.oauth2_url=b.oauth2Url||j.oauth2_url,j.client_id=b.clientId||j.client_id,j.options=a.extend({},j.options,b.options||{}),j.auto_auth=null==b.autoAuth?j.auto_auth:b.autoAuth}function h(b,f,h,i){function k(){function b(){a.element(i.document).find("body").removeAttr("oauth-hide")}if(!j.client_id||!j.redirect_uri||!j.oauth2_url)throw new Error("Missing required configuration options");var d=e(i.location.href);{if(!d.access_token||!d.expires_in)return!n.isAuthenticated()&&a.isObject(n.getToken())?void n.authenticate():n.isAuthenticated()?void b():void(j.auto_auth&&n.authenticate());if(m=!0,c(d,i),b(),d.state){var f=d.state.split("?");h.path(f[0]),h.search(e(f.slice(1).length?"#"+f.slice(1)[0]:""));var g=d.hash;g&&"undefined"!==g&&h.hash(g)}else~h.hash().indexOf("/access_token")&&h.hash("")}}var m=!1,n={};return n.registerCallback=function(a){return!m||a()},n.authenticate=function(){var a=d(j,h);i.location.href=a,j.redirecting=!0},n.lateConfig=g,n.isAuthenticated=function(){var b=a.fromJson(i.sessionStorage[l+"-"+j.client_id]),d=(new Date).getTime(),e=a.isDefined(b)&&parseInt(b.expires_at)>d;return e&&c(b,i),e},n.wasAuthenticated=function(){return a.isDefined(a.fromJson(i.sessionStorage[l+"-"+j.client_id]))},n.updateToken=function(){var e=f.defer();return b.get("$http")({url:d(j,h),method:"GET",withCredentials:!0,headers:{Accept:"application/json"}}).success(function(b){return a.isObject(b)?void e.resolve(c(b,i)):void e.reject("Token was not received as JSON")}).error(function(){console.warn("Attempted to retrieve token async, fallback to default method"),e.reject("Couldn't get token, re-authenticate"),n.authenticate()}),e.promise},n.getConfig=function(){return a.copy(j)},n.getToken=function(){return a.fromJson(i.sessionStorage[l+"-"+j.client_id])},k(),n}function i(a,b){b.defaults.useXDomain=!0,delete b.defaults.headers.common["X-Requested-With"],a.factory("authInterceptor",["$oauth2","$q","$window",function(a,b,d){return{request:function(e){return f(e.url,j)?a.isAuthenticated()?(e.headers.Authorization="Bearer "+a.getToken().access_token,e):a.isAuthenticated()||!a.wasAuthenticated()&&!j.auto_auth||j.redirecting?b.reject(e):a.updateToken().then(function(a){return e.headers.Authorization="Bearer "+a.access_token,c(a,d),b.when(e)},function(){return b.reject("Invalid token cant be used for request")}):e}}}]),b.interceptors.push("authInterceptor")}a.module("ng-auth",[]);var j={redirecting:!1,content_urls:[],popup:!1,scope:[],options:{},auto_auth:!0},k=3e5,l="ng-auth",m=/([^&=]+)=([^&]*)/g;i.prototype.$get=["$injector","$q","$location","$window",h],i.prototype.configure=g,a.module("ng-auth").provider("$oauth2",["$provide","$httpProvider",i]),a.module("ng-auth").constant("oauth2-key",l)}(angular);